#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <openssl/rsa.h>
#include <openssl/pem.h>
#include "prod_config.h"
#include "crypt.h"
#define XOR_NUM "Rn/1chD693T^!135565=*--.|??1Su34mG!"

static char *b64_enc(unsigned char* input, size_t in_len)
{
    char *buf=NULL;
    BIO *bmem, *b64;
    BUF_MEM *bptr;

    b64 = BIO_new(BIO_f_base64());
    if (!b64) return buf;
    BIO_set_flags(b64, BIO_FLAGS_BASE64_NO_NL);
    bmem = BIO_new(BIO_s_mem());
    if (bmem) {
        b64 = BIO_push(b64, bmem);
        if (BIO_write(b64, input, in_len)==in_len) {
            (void)BIO_flush(b64);
            BIO_get_mem_ptr(b64, &bptr);

            buf = (char*)malloc(bptr->length*2+1);
            if (buf) {
                memcpy(buf, bptr->data, bptr->length);
                buf[bptr->length] = '\0';
            }
        }
    }

    BIO_free_all(b64);

    return buf;
}
static int encsn(unsigned char* src, unsigned char** dest,int* dlen) 
{

	char *enc_pack;
	RSA *key=NULL;
	int i;
	char prikey[230]={};
	int a[]=
	{ 0xd8,0xd8,0xd8,0xd8,0xd8,0xb7,0xb0,0xb2,0xbc,0xbb,0xd5,0xa7,0xa6,0xb4,0xd5,0xa5,0xa7,0xbc,0xa3,0xb4,0xa1,0xb0,0xd5,0xbe,0xb0,0xac,0xd8,0xd8,0xd8,0xd8,0xd8,0xff,0xb8,0xbd,0x92,0xb6,0xb4,0xa4,0xb4,0xb6,0xb3,0x92,0xb6,0x80,0xc7,0xcc,0x93,0x93,0x93,0xc7,0xc5,0x92,0x9d,0xbb,0xa4,0x99,0xbb,0x8c,0xbd,0xb7,0x85,0xbd,0x9a,0x93,0xb7,0x8c,0x92,0xa5,0xbf,0x84,0xb8,0xb6,0xb4,0x82,0xb0,0xb4,0xb4,0xa4,0xbc,0xa3,0x94,0x9a,0x8f,0x90,0xbc,0xc6,0x80,0x9f,0x9d,0xb8,0xb7,0xb8,0xb4,0xad,0xc4,0xa6,0xff,0xad,0xb3,0x9d,0xb3,0xb4,0xc0,0xad,0x85,0xc7,0x94,0xa2,0xc0,0xb4,0x92,0x86,0xbb,0x9a,0xac,0xc1,0xa4,0x86,0xc7,0x83,0xa1,0xbc,0xa0,0x83,0x91,0xc6,0xa4,0xbc,0xb9,0xb1,0xbb,0xa5,0xc5,0x84,0xa3,0xb4,0xac,0x97,0xbf,0x97,0xa6,0xb1,0x9b,0xcd,0xb6,0xb6,0x82,0x99,0xac,0xc3,0xb9,0xda,0xb7,0xb2,0x96,0x94,0x91,0xa7,0xaf,0xac,0x81,0xff,0xb4,0x92,0x86,0xbc,0xc3,0x80,0xba,0xda,0xba,0xda,0xc6,0x80,0x85,0x8d,0xc1,0xaf,0x9e,0x82,0xbc,0xb9,0xb6,0xcd,0xbc,0xa4,0xa0,0xba,0xc0,0xaf,0xc6,0xb2,0xad,0xbc,0xa0,0xb3,0x9a,0xc8,0xff,0xd8,0xd8,0xd8,0xd8,0xd8,0xb0,0xbb,0xb1,0xd5,0xa7,0xa6,0xb4,0xd5,0xa5,0xa7,0xbc,0xa3,0xb4,0xa1,0xb0,0xd5,0xbe,0xb0,0xac,0xd8,0xd8,0xd8,0xd8,0xd8,0xff,0xf5};

	for(i=0;i<230;i++){
		prikey[i] = a[i];
		prikey[i]^=0xF5;
	}
	//for(i=0;i<sizeof(prikey);++i)
	//prikey[i]^=0xF5;
	key = RSA_new();
	BIO *bio=BIO_new_mem_buf(prikey,sizeof(prikey));
	if(!bio) return -1;
	if(!PEM_read_bio_RSAPrivateKey(bio, &key, NULL, NULL))
	{
		BIO_free_all(bio);
		return -1;
	}
	
	*dlen = RSA_size(key);
	*dest = (unsigned char *)malloc(*dlen);
	memset(*dest,0,*dlen);
	BIO_free_all(bio);
	//full in padding 
	unsigned char lpFu[21]; 
	int j;
	unsigned char *p;
	p = lpFu;
	*(p++) = 0;
	*(p++) = 1;
	j = 21-3-16;
	memset(p, 0xff, j);
	p += j;
	*(p++) = '\0';
	memcpy(p, src, 16);
/*
	for(i=0;i<21;++i)
	{
		printf("%02x:",lpFu[i]);
	}
*/
//	return RSA_private_encrypt(10,//*dlen - 11, 
//		src, *dest, key, RSA_PKCS1_PADDING);
	return RSA_private_encrypt(21,//*dlen - 11,
              lpFu, *dest, key, RSA_NO_PADDING);
}
static void trans(unsigned char* buf, int len)
{
	int i;
	for(i=0;i<len;++i)
		buf[i]=(buf[i]+0x18)^XOR_NUM[i+5];
}

static void conv(unsigned char *b4)
{
	static char codes[]="0123456789ABCDEFGHIJKLMNOPQRSTUV";
	int len=strlen((const char*)b4);
	int i;
	int bytes=(len+4)/5;
	char *tmp=(char*)calloc(1,bytes);
	int flag;
	unsigned int cur=0;

	for(i=0;i<len;++i)
	{
		flag=0;	
		if(b4[i]>='a' && b4[i]<='z')
		{
			b4[i]-=('a'-'A');
			flag=1;
		}
		else if(b4[i]=='+')
		{
			b4[i]='7';
			flag=1;
		}
		else if(b4[i]=='/')
		{
			b4[i]='9';
			flag=1;
		}
		else if(b4[i]=='=')
		{
			b4[i]='5';
			flag=1;
		}
		if(flag)
		{
			tmp[i/5]|=(0x10>>(i%5));
			cur+=b4[i];
		}
	}
	for(i=0;i<bytes;++i)
	{
		b4[len+i]=codes[tmp[i]];
	}
	b4[len+i]=codes[cur%32];
	b4[len+i+1]='\0';
	free(tmp);
}

int generate(const struct product_info *info, char* ret)
{
	unsigned char *result;
	char *mstr;
	int i,printed=0;
	int destlen,dlen,len;

	destlen=encsn((unsigned char* )info,(unsigned char**)&result,&dlen);
	if(destlen<0)
	{
		free(result);
		return -1;
	}
	trans(result,destlen);
	mstr=b64_enc(result,destlen);
	conv((unsigned char*) mstr);
	len=strlen(mstr);
	for(i=0;i<len;++i)
	{
		sprintf(ret+printed++,"%c",mstr[i]);
		if(i>0 && i<len-1 && (i+1)%7==0) sprintf(ret+printed++,"-");
	}
	free(mstr);
	free(result);
	return 0;
}

